# Firebase Prompts System 更新文档

## 📋 概述

已完成对 Firebase Prompts 集合的系统 prompt 动态加载和变量替换功能的升级。

## 🎯 核心功能

### 1. System Prompt 加载 (必须模式)

**位置**: `backend/src/services/scriptService.ts` - `getSystemPromptTemplate()` 方法

当用户开始游戏时:
1. 根据脚本类型确定要加载的 prompt:
   - `single-single-sp`: 单用户单AI剧本
   - `single-multi-sp`: 单用户多AI剧本
   - `multi-multi-sp`: 多用户多AI剧本

2. 从 Firebase `Prompts` 集合加载对应文档

3. **错误处理 (必须)**: 
   - 如果找不到文档 → 直接抛出错误
   - 如果找不到字段 → 直接抛出错误
   - **不再使用默认的 system prompt 作为备用**

### 2. 完整的变量替换支持

**位置**: `backend/src/routes/game.ts` - 第 330-406 行

#### 支持的变量格式

所有变量都使用 `{{变量名}}` 格式在 Firebase Prompts 文档中使用。

##### AI 角色信息 (单个角色)
对于第一个角色:
- `{{姓名}}` - 角色姓名
- `{{和用户的身份}}` - 与用户的身份关系
- `{{年龄}}` - 角色年龄
- `{{国籍}}` - 国籍
- `{{外貌描述}}` - 外貌描述
- `{{星座}}` - 星座
- `{{MBTI}}` - MBTI 性格类型
- `{{面对未知的态度}}` - 面对未知事物的态度
- `{{恐惧/软肋}}` - 恐惧或软肋
- `{{喜好/特长}}` - 喜好和特长 (以 `、` 分隔)
- `{{讨厌的东西}}` - 讨厌的东西 (以 `、` 分隔)
- `{{超能力（等级）}}` - 超能力及等级 (如 "心灵感应(5级)、瞬间移动(3级)")
- `{{超能力}}` - 超能力详细描述

对于第 2、3 等角色 (使用 `2_`、`3_` 前缀):
- `{{2_姓名}}`、`{{3_姓名}}` 等
- `{{2_MBTI}}`、`{{3_MBTI}}` 等
- ... (所有上述变量都支持)

##### AI 角色信息 (组合)
- `{{AI角色名}}` - 所有AI角色名称 (以 `、` 分隔)
- `{{AI角色身份}}` - 所有AI角色身份 (以 `、` 分隔)
- `{{AI角色年龄}}` - 所有AI角色年龄 (以 `、` 分隔)
- `{{AI角色国籍}}` - 所有AI角色国籍 (以 `、` 分隔)
- `{{AI角色MBTI}}` - 所有AI角色MBTI (以 `、` 分隔)
- `{{AI角色性格}}` - 所有AI角色性格特征 (多角色用 `|` 分隔)

##### 脚本角色信息 (单个角色)
对于第一个脚本角色:
- `{{脚本角色名}}` - 脚本角色名称
- `{{角色简介}}` - 角色简介
- `{{角色目标}}` - 角色目标
- `{{角色背景}}` - 角色背景故事

对于第 2、3 等脚本角色 (使用 `2_`、`3_` 前缀):
- `{{2_脚本角色名}}`、`{{3_脚本角色名}}` 等
- ... (所有上述变量都支持)

##### 脚本角色信息 (组合)
- `{{脚本角色}}` - 所有脚本角色名称 (以 `、` 分隔)
- `{{角色背景}}` - 所有脚本角色背景 (以 `\n\n` 分隔)
- `{{角色目标}}` - 所有脚本角色目标 (以 `、` 分隔)

##### 故事信息
- `{{故事内容}}` - 脚本的故事背景
- `{{剧本名}}` - 脚本名称/ID
- `{{角色网络}}` - 角色网络信息 (JSON 格式)

## 📝 Firebase Prompts 集合格式

每个文档需要包含 `systemPrompt`、`system_prompt` 或 `prompt` 字段（任选其一）:

```json
{
  "systemPrompt": "你是一个{{剧本名}}的故事叙述者...\n\n【参与的AI角色】\n{{AI角色名}}\nMBTI: {{AI角色MBTI}}\n\n【脚本角色】\n{{脚本角色}}\n目标: {{角色目标}}\n\n...",
  "描述": "单用户单AI剧本的系统提示模板"
}
```

### 完整示例

**文档 ID**: `single-multi-sp`

```json
{
  "systemPrompt": "你是一个复杂的故事叙述者，需要管理多个AI角色的互动。\n\n【主要设置】\n故事: {{剧本名}}\n背景: {{故事内容}}\n\n【角色A】\n名字: {{姓名}}\n身份: {{和用户的身份}}\nMBTI: {{MBTI}}\n特长: {{喜好/特长}}\n目标: {{角色目标}}\n背景: {{角色背景}}\n\n【角色B】\n名字: {{2_姓名}}\nMBTI: {{2_MBTI}}\n特长: {{2_喜好/特长}}\n\n现在开始生成故事...",
  "类型": "single-multi-sp",
  "描述": "单用户多AI剧本模板"
}
```

## 🔄 工作流程

```
用户点击开始游戏
    ↓
确定脚本类型 (single-single-sp / single-multi-sp / multi-multi-sp)
    ↓
从 Firebase Prompts 集合加载 system prompt 模板
    ↓
收集所有参与角色信息
    ↓
构建替换映射 (变量名 → 实际值)
    ↓
替换模板中的所有 {{变量}}
    ↓
完整的 system prompt 发送给 OpenRouter AI
    ↓
AI 根据自定义 prompt 生成故事
```

## 🔧 技术细节

### 变量替换逻辑
- 文件: `backend/src/services/scriptService.ts` - `replacePromptTemplate()` 方法
- 使用正则表达式: `/{{变量名}}/g`
- 替换所有出现的变量为对应的值

### 错误处理
当 Prompts 集合中找不到对应文档时:
```
❌ Prompts 集合中找不到 {{scriptType}} 文档
→ 抛出 Error: System prompt template not found for script type: {{scriptType}}
→ 游戏初始化失败，用户收到错误提示
```

## ✅ 已实现的代码变更

### 1. `backend/src/services/scriptService.ts`
- ✅ 修改 `getSystemPromptTemplate()` 为必须模式
- ✅ 移除 `getDefaultSystemPrompt()` 方法
- ✅ `replacePromptTemplate()` 支持完整的变量替换

### 2. `backend/src/routes/game.ts`
- ✅ 在 `POST /sessions/:sessionId/choose` 路由中
- ✅ 构建完整的 replacements 对象
- ✅ 支持单个角色变量 (无前缀)
- ✅ 支持多个角色变量 (带 2_、3_ 等前缀)
- ✅ 支持组合变量 (所有角色数据)
- ✅ 支持角色网络变量

## 🚀 使用建议

### 最佳实践

1. **为每个脚本类型创建精细化的 prompt**
   - 单单: 简化的单角色提示
   - 单多: 复杂的多角色协调提示
   - 多多: 最复杂的多用户场景提示

2. **使用具体的变量而不是组合变量**
   - ❌ 不要: 使用 `{{AI角色名}}、{{AI角色MBTI}}`
   - ✅ 应该: 在 prompt 中直接列出每个角色

   例如:
   ```
   【角色A】
   名字: {{姓名}}
   MBTI: {{MBTI}}
   特长: {{喜好/特长}}
   
   【角色B】
   名字: {{2_姓名}}
   MBTI: {{2_MBTI}}
   特长: {{2_喜好/特长}}
   ```

3. **充分利用角色信息**
   - 使用 `{{面对未知的态度}}`、`{{恐惧/软肋}}`
   - 如果有超能力，使用 `{{超能力（等级）}}` 和 `{{超能力}}`

4. **测试变量替换**
   - 在后端日志中查看:
   ```
   ✅ System prompt 准备就绪，长度: XXXX
   ```

## 📊 调试

### 查看替换后的 system prompt
在后端代码中添加:
```typescript
console.log('📝 替换后的 system prompt:');
console.log(customSystemPrompt);
```

### 查看原始的 replacements 对象
```typescript
console.log('🔍 可用变量:');
console.log(JSON.stringify(replacements, null, 2));
```

## ⚠️ 重要注意事项

1. **Firebase Prompts 集合必须存在**
   - 如果缺少任何脚本类型的文档，游戏将无法启动

2. **变量名完全匹配**
   - Prompts 中的变量必须完全匹配系统提供的变量名
   - 例如: `{{姓名}}` 而不是 `{{名字}}`

3. **前缀规则**
   - 第一个角色无前缀: `{{姓名}}`
   - 第二个角色: `{{2_姓名}}`
   - 第三个角色: `{{3_姓名}}`
   - 依此类推...

4. **多角色变量**
   - 当有多个角色时，某些组合变量会用分隔符连接
   - 分隔符规则:
     - 名称/身份/年龄等: 用 `、` 分隔
     - 背景信息: 用 `\n\n` 分隔
     - 性格特征: 多角色用 ` | ` 分隔

## 🎓 示例

### 单人单AI prompt 示例
```
{{剧本名}}的故事系统提示

背景: {{故事内容}}

主角信息:
- 姓名: {{姓名}}
- 身份: {{和用户的身份}}
- MBTI: {{MBTI}}
- 性格特征: {{喜好/特长}}

角色目标: {{角色目标}}
角色背景: {{角色背景}}

请根据故事背景和角色信息生成引人入胜的故事...
```

### 单人多AI prompt 示例
```
{{剧本名}} - 多角色互动故事

【故事背景】
{{故事内容}}

【角色A】
姓名: {{姓名}}
MBTI: {{MBTI}}
特长: {{喜好/特长}}
目标: {{角色目标}}

【角色B】
姓名: {{2_姓名}}
MBTI: {{2_MBTI}}
特长: {{2_喜好/特长}}
目标: {{2_角色目标}}

请协调这两个角色的互动，生成故事下一段...
```

## 📞 技术支持

如有问题:
1. 检查 Firebase Prompts 集合中是否存在所需文档
2. 查看后端日志中的错误信息
3. 验证变量名是否完全匹配
4. 确保 JSON 格式正确

