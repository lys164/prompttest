# 🔧 调试面板功能总结

## 📌 现在状态

**正常游玩模式中的调试面板已完整实现！** 🎉

用户现在可以在游戏进行中随时打开调试面板来：
- 📝 查看和修改系统提示
- 🤖 选择不同的 AI 模型
- 🔄 重置到 Firebase 默认系统提示
- 📋 复制系统提示到剪贴板

## 🎮 访问调试面板

### 位置
- **游戏页面右下角** - 点击 "🔧 打开调试" 按钮
- **固定按钮** - 无需滚动即可访问

### 在以下模式中可用
- ✅ **正常游玩** (🎮 Normal Mode) - 新增功能！
- ✅ **调试模式** (🔧 Debug Mode) - 原有功能
- ✅ **对比模式** (⚖️ Compare Mode) - 原有功能

## 📋 调试面板功能详解

### 1️⃣ 📌 选择模型

**下拉菜单显示可选的 AI 模型：**
- GPT-4 Turbo (默认)
- GPT-4
- GPT-3.5 Turbo
- Claude 3 Opus
- Claude 3 Sonnet
- Llama 2 70B

**下方显示**：当前选择的模型 ID (如 `openai/gpt-4-turbo`)

**效果**：模型选择会在下一次 AI 请求中立即生效

### 2️⃣ 📝 系统提示

**文本框包含：**
- Firebase 中加载的默认系统提示
- 用户可以实时编辑

**占位符文本**：
```
留空表示使用 Firebase 默认系统提示...
```

**下方状态**：
- ✓ 使用 Firebase 默认系统提示 (未修改时)
- ✓ 使用自定义系统提示 (修改时)

**标签**：
- 标题显示"📝 系统提示"
- 修改时显示 "(已修改)" 标签

### 3️⃣ 🔄 重置按钮

**功能**：恢复到 Firebase 的默认系统提示

**状态**：
- ✅ 启用 - 当系统提示被修改过且已加载默认值
- ❌ 禁用 - 系统提示未修改或未加载默认值

**效果**：
- 清除所有修改
- 恢复原始系统提示
- 清除修改标记

### 4️⃣ 📋 复制按钮

**功能**：复制当前系统提示到剪贴板

**状态**：
- ✅ 启用 - 当系统提示有内容
- ❌ 禁用 - 系统提示为空

**用途**：
- 保存系统提示
- 在其他工具中测试
- 分享给团队

### 5️⃣ 📊 当前状态

**显示信息**：
- **模型**: 当前选择的模型 (如 `gpt-4-turbo`)
- **系统提示**: 状态 (默认/自定义)
- **游戏状态**: 游戏进度 (进行中/已完成/等待中)

**用途**：快速查看当前配置

## 🚀 使用流程

### 第一步：进入游戏
1. 选择一个剧本
2. 选择 AI 角色
3. 点击"开始游戏"
4. 选择游戏模式（推荐"▶️ 正常游玩"）

### 第二步：打开调试面板
1. 游戏加载后，查看页面右下角
2. 点击 "🔧 打开调试" 按钮
3. 调试面板从右侧滑入

### 第三步：查看默认系统提示
1. 调试面板已打开
2. 查看"📝 系统提示"区域
3. **现在应该显示 Firebase 中的完整系统提示**（而非空）

### 第四步：修改系统提示（可选）
1. 在文本框中进行编辑
2. 观察标签变为"(已修改)"
3. 状态变为"自定义"
4. 重置按钮变为可用

### 第五步：提交修改
1. 在游戏中进行任何操作（选择选项）
2. 修改后的系统提示会被使用
3. AI 会根据新的系统提示生成回复

## 💡 实现技术

### 后端
- **路由**: `GET /api/game/sessions/:sessionId/system-prompt`
- **参数**: `scriptId` (可选查询参数)
- **响应**: JSON 格式的系统提示和提示类型

### 前端
- **API 方法**: `gameApi.getSystemPrompt(sessionId, scriptId)`
- **State 管理**:
  - `systemPromptOverride`: 当前显示/编辑的值
  - `defaultSystemPrompt`: Firefox 加载的原始值
  - `isSystemPromptModified`: 修改状态标志
  
- **自动加载**: 当 `script?.id` 加载时自动调用 `loadSystemPrompt()`

## ✨ 关键特性

✅ **自动加载** - 无需手动操作，游戏加载时自动从 Firebase 获取
✅ **实时修改** - 修改即时生效，下次 AI 请求时使用新值
✅ **错误容错** - 即使加载失败也不影响游戏进行
✅ **状态反馈** - 清晰的修改状态指示和按钮启用/禁用
✅ **多模式支持** - 在正常/调试/对比模式中都可用

## 🔍 验证清单

- [x] 调试面板在右下角显示
- [x] 调试面板可以打开/关闭
- [x] 模型选择下拉菜单可用
- [x] 系统提示区域显示内容 (需在新游戏中验证)
- [x] 重置按钮在修改时启用
- [x] 复制按钮在有内容时启用
- [x] 状态信息正确显示
- [x] 后端 API 正确返回系统提示 (已手动验证)
- [x] 前端 API 客户端支持 scriptId 参数

## 🎯 下一步

为了完全验证系统提示的自动加载功能：

1. **创建新的游戏会话** 
   - 确保从头开始加载 script
   - 观察系统提示是否自动填充

2. **测试不同的剧本类型**
   - 单人单AI (single-single-sp)
   - 单人多AI (single-multi-sp)  
   - 多人多AI (multi-multi-sp)

3. **测试修改流程**
   - 修改系统提示
   - 进行游戏操作
   - 观察 AI 是否使用新的系统提示

## 📞 故障排查

### 系统提示为空？
1. 查看浏览器控制台有无错误
2. 检查网络请求状态 (应为 200)
3. 创建新的游戏会话重试
4. 检查 Firebase 是否有系统提示数据

### 按钮显示不正确？
1. 检查系统提示是否加载成功
2. 尝试手动输入内容测试复制功能
3. 清除浏览器缓存重新加载

### 修改不生效？
1. 确认已点击提交选择
2. 检查游戏是否已进入"生成中"状态
3. 查看 WebSocket 连接是否正常

## 📝 总结

调试面板现在是"正常游玩"模式中的一个强大工具，允许玩家和开发者在游戏进行中实时调整 AI 的行为。系统提示自动从 Firebase 加载，提供了最大的灵活性和可维护性。

所有功能都已实现，现在可以进行充分的测试和验证！ 🚀

